{% extends "admin/base.html" %}

{% block page_title %}Neue Komponente hinzufügen{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">Neue Komponente hinzufügen</h4>
        <p class="text-muted mb-0">Erstellen Sie eine neue PC-Komponente für den Konfigurator</p>
    </div>
    <a href="{{ url_for('admin_components') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Zurück zur Übersicht
    </a>
</div>

<form method="POST" class="needs-validation" novalidate>
    <!-- Basic Information -->
    <div class="form-section">
        <h5 class="mb-3">
            <i class="fas fa-info-circle"></i> Grundinformationen
        </h5>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="name" class="form-label">Name *</label>
                    <input type="text" 
                           class="form-control" 
                           id="name" 
                           name="name" 
                           placeholder="z.B. AMD Ryzen 7 7800X3D"
                           required>
                    <div class="invalid-feedback">
                        Bitte geben Sie einen Namen ein.
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="category" class="form-label">Kategorie *</label>
                    <select class="form-select" id="category" name="category" required onchange="updateSpecFields()">
                        <option value="">Kategorie wählen</option>
                        <option value="cpus">CPU (Prozessoren)</option>
                        <option value="motherboards">Motherboards</option>
                        <option value="ram">RAM (Arbeitsspeicher)</option>
                        <option value="gpus">GPU (Grafikkarten)</option>
                        <option value="ssds">SSD (Speicher)</option>
                        <option value="cases">Cases (Gehäuse)</option>
                        <option value="psus">PSU (Netzteile)</option>
                        <option value="coolers">Cooler (Kühler)</option>
                    </select>
                    <div class="invalid-feedback">
                        Bitte wählen Sie eine Kategorie.
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="price" class="form-label">Preis (€) *</label>
                    <div class="input-group">
                        <span class="input-group-text">€</span>
                        <input type="number" 
                               class="form-control" 
                               id="price" 
                               name="price" 
                               step="0.01" 
                               min="0"
                               placeholder="299.99"
                               required>
                    </div>
                    <div class="invalid-feedback">
                        Bitte geben Sie einen gültigen Preis ein.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Specifications -->
    <div class="form-section">
        <h5 class="mb-3">
            <i class="fas fa-cogs"></i> Spezifikationen
        </h5>
        
        <div id="spec-fields">
            <p class="text-muted">Wählen Sie zuerst eine Kategorie aus, um die entsprechenden Spezifikations-Felder anzuzeigen.</p>
        </div>
        
        <!-- Hidden field for specifications JSON -->
        <input type="hidden" id="specifications" name="specifications" value="{}">
    </div>

    <!-- Submit Button -->
    <div class="form-section">
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('admin_components') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Abbrechen
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Komponente speichern
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Specification fields for each category
const specFields = {
    cpus: [
        {name: 'socket', label: 'Socket', type: 'text', placeholder: 'AM5, LGA1700', required: true},
        {name: 'cores', label: 'Kerne', type: 'number', min: 1, required: true},
        {name: 'threads', label: 'Threads', type: 'number', min: 1, required: true},
        {name: 'base_clock', label: 'Basistakt (GHz)', type: 'number', step: 0.1, min: 0, required: true},
        {name: 'boost_clock', label: 'Boost-Takt (GHz)', type: 'number', step: 0.1, min: 0, required: true},
        {name: 'tdp', label: 'TDP (W)', type: 'number', min: 1, required: true},
        {name: 'memory_support', label: 'Speicher-Unterstützung', type: 'text', placeholder: 'DDR5-5200', required: true}
    ],
    motherboards: [
        {name: 'socket', label: 'Socket', type: 'text', placeholder: 'AM5, LGA1700', required: true},
        {name: 'chipset', label: 'Chipsatz', type: 'text', placeholder: 'X670E, Z790', required: true},
        {name: 'ram_slots', label: 'RAM-Slots', type: 'number', min: 1, max: 8, required: true},
        {name: 'ram_types', label: 'RAM-Typen', type: 'text', placeholder: 'DDR5,DDR4 (kommagetrennt)', required: true},
        {name: 'max_ram_speed', label: 'Max. RAM-Geschwindigkeit (MHz)', type: 'number', min: 1000, required: true},
        {name: 'max_ram_capacity', label: 'Max. RAM-Kapazität (GB)', type: 'number', min: 16, required: true},
        {name: 'form_factor', label: 'Formfaktor', type: 'text', placeholder: 'ATX, Micro-ATX, Mini-ITX', required: true},
        {name: 'power_consumption', label: 'Stromverbrauch (W)', type: 'number', min: 1, required: true}
    ],
    ram: [
        {name: 'type', label: 'RAM-Typ', type: 'text', placeholder: 'DDR5, DDR4', required: true},
        {name: 'capacity', label: 'Kapazität (GB)', type: 'number', min: 4, required: true},
        {name: 'speed', label: 'Geschwindigkeit (MHz)', type: 'number', min: 1000, required: true},
        {name: 'modules', label: 'Anzahl Module', type: 'number', min: 1, max: 4, required: true},
        {name: 'latency', label: 'Latenz', type: 'text', placeholder: 'CL30, CL36', required: true},
        {name: 'power_consumption', label: 'Stromverbrauch (W)', type: 'number', min: 1, required: true}
    ],
    gpus: [
        {name: 'memory', label: 'Videospeicher (GB)', type: 'number', min: 1, required: true},
        {name: 'memory_type', label: 'Speicher-Typ', type: 'text', placeholder: 'GDDR6X, GDDR6', required: true},
        {name: 'base_clock', label: 'Basistakt (MHz)', type: 'number', min: 500, required: true},
        {name: 'boost_clock', label: 'Boost-Takt (MHz)', type: 'number', min: 500, required: true},
        {name: 'power_consumption', label: 'Stromverbrauch (W)', type: 'number', min: 50, required: true},
        {name: 'length', label: 'Länge (mm)', type: 'number', min: 100, required: true},
        {name: 'width', label: 'Breite (mm)', type: 'number', min: 50, required: true},
        {name: 'height', label: 'Höhe (mm)', type: 'number', min: 20, required: true}
    ],
    ssds: [
        {name: 'capacity', label: 'Kapazität (GB)', type: 'number', min: 120, required: true},
        {name: 'interface', label: 'Schnittstelle', type: 'text', placeholder: 'NVMe, SATA', required: true},
        {name: 'form_factor', label: 'Formfaktor', type: 'text', placeholder: 'M.2 2280, 2.5"', required: true},
        {name: 'read_speed', label: 'Lesegeschwindigkeit (MB/s)', type: 'number', min: 100, required: true},
        {name: 'write_speed', label: 'Schreibgeschwindigkeit (MB/s)', type: 'number', min: 100, required: true}
    ],
    cases: [
        {name: 'form_factor', label: 'Formfaktor', type: 'text', placeholder: 'ATX, Micro-ATX, Mini-ITX', required: true},
        {name: 'max_gpu_length', label: 'Max. GPU-Länge (mm)', type: 'number', min: 200, required: true},
        {name: 'max_cooler_height', label: 'Max. Kühler-Höhe (mm)', type: 'number', min: 100, required: true},
        {name: 'length', label: 'Gehäuse-Länge (mm)', type: 'number', min: 200, required: true},
        {name: 'width', label: 'Gehäuse-Breite (mm)', type: 'number', min: 150, required: true},
        {name: 'height', label: 'Gehäuse-Höhe (mm)', type: 'number', min: 300, required: true}
    ],
    psus: [
        {name: 'wattage', label: 'Leistung (W)', type: 'number', min: 300, required: true},
        {name: 'efficiency', label: 'Effizienz', type: 'text', placeholder: '80+ Gold, 80+ Platinum', required: true},
        {name: 'modular', label: 'Modular', type: 'checkbox'},
        {name: 'form_factor', label: 'Formfaktor', type: 'text', placeholder: 'ATX, SFX', required: true}
    ],
    coolers: [
        {name: 'type', label: 'Typ', type: 'text', placeholder: 'Air, AIO', required: true},
        {name: 'height', label: 'Höhe (mm)', type: 'number', min: 20, required: true},
        {name: 'compatible_sockets', label: 'Kompatible Sockets', type: 'text', placeholder: 'AM4,AM5,LGA1700 (kommagetrennt)', required: true},
        {name: 'tdp_rating', label: 'TDP-Rating (W)', type: 'number', min: 50, required: true}
    ]
};

function updateSpecFields() {
    const category = document.getElementById('category').value;
    const container = document.getElementById('spec-fields');
    
    if (!category || !specFields[category]) {
        container.innerHTML = '<p class="text-muted">Wählen Sie zuerst eine Kategorie aus, um die entsprechenden Spezifikations-Felder anzuzeigen.</p>';
        return;
    }
    
    const fields = specFields[category];
    let html = '<div class="row">';
    
    fields.forEach((field, index) => {
        const colClass = field.type === 'checkbox' ? 'col-12' : 'col-md-6';
        
        html += `<div class="${colClass}">`;
        html += `<div class="mb-3">`;
        
        if (field.type === 'checkbox') {
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${field.name}" name="${field.name}">
                    <label class="form-check-label" for="${field.name}">
                        ${field.label}
                    </label>
                </div>
            `;
        } else {
            html += `<label for="${field.name}" class="form-label">${field.label}${field.required ? ' *' : ''}</label>`;
            
            let inputHtml = `<input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}"`;
            
            if (field.placeholder) inputHtml += ` placeholder="${field.placeholder}"`;
            if (field.min) inputHtml += ` min="${field.min}"`;
            if (field.max) inputHtml += ` max="${field.max}"`;
            if (field.step) inputHtml += ` step="${field.step}"`;
            if (field.required) inputHtml += ` required`;
            
            inputHtml += '>';
            
            html += inputHtml;
            
            if (field.required) {
                html += '<div class="invalid-feedback">Dieses Feld ist erforderlich.</div>';
            }
        }
        
        html += '</div></div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Collect specification data on form submit
function collectSpecificationData() {
    const category = document.getElementById('category').value;
    if (!category || !specFields[category]) {
        return {};
    }
    
    const specs = {};
    const fields = specFields[category];
    
    fields.forEach(field => {
        const element = document.getElementById(field.name);
        if (element) {
            if (field.type === 'checkbox') {
                specs[field.name] = element.checked;
            } else if (field.type === 'number') {
                specs[field.name] = parseFloat(element.value) || 0;
            } else if (field.name === 'compatible_sockets' || field.name === 'ram_types') {
                // Split comma-separated values into arrays
                specs[field.name] = element.value.split(',').map(s => s.trim()).filter(s => s);
            } else {
                specs[field.name] = element.value;
            }
        }
    });
    
    return specs;
}

// Form validation and spec collection
(function() {
    'use strict';
    window.addEventListener('load', function() {
        const forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                // Collect specification data and update hidden field
                const specs = collectSpecificationData();
                document.getElementById('specifications').value = JSON.stringify(specs);
                
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}